<!DOCTYPE html>
<html lang="fr">
  <head>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>

    <!-- Composant : lecture/pause au regard -->
    <script>
      AFRAME.registerComponent('play-on-look', {
        schema: {videoId: {default: ''}},
        init: function () {
          const video = document.querySelector(this.data.videoId);
          this.el.addEventListener('mouseenter', () => video && video.play());
          this.el.addEventListener('mouseleave', () => video && video.pause());
        }
      });
    </script>

    <!-- Composant : effet pop-out quand on regarde -->
    <script>
      AFRAME.registerComponent('pop-out-on-look', {
        schema: {
          scaleFactor: {default: 1.3},
          moveForward: {default: 0.15},
          duration: {default: 300}
        },

        init: function () {
          const el = this.el;
          const originalPos = el.object3D.position.clone();
          const originalScale = el.object3D.scale.clone();
          const d = this.data;

          el.addEventListener('mouseenter', () => {
            el.setAttribute("animation__pos", {
              property: "position",
              to: `${originalPos.x} ${originalPos.y} ${originalPos.z - d.moveForward}`,
              dur: d.duration,
              easing: "easeOutQuad"
            });
            el.setAttribute("animation__scale", {
              property: "scale",
              to: `${originalScale.x * d.scaleFactor} ${originalScale.y * d.scaleFactor} ${originalScale.z * d.scaleFactor}`,
              dur: d.duration,
              easing: "easeOutQuad"
            });
          });

          el.addEventListener('mouseleave', () => {
            el.setAttribute("animation__pos", {
              property: "position",
              to: `${originalPos.x} ${originalPos.y} ${originalPos.z}`,
              dur: d.duration,
              easing: "easeOutQuad"
            });
            el.setAttribute("animation__scale", {
              property: "scale",
              to: `${originalScale.x} ${originalScale.y} ${originalScale.z}`,
              dur: d.duration,
              easing: "easeOutQuad"
            });
          });
        }
      });
    </script>

  </head>

  <body>

    <!-- Écran pour activer l’audio -->
    <div id="startAudio"
         style="position: fixed; top:0; left:0; width:100%; height:100%;
                background:black; color:white; display:flex;
                justify-content:center; align-items:center; font-size:28px;
                cursor:pointer; z-index: 999;">
      Cliquer pour commencer
    </div>

    <a-scene>

      <!-- ASSETS -->
      <a-assets>

        <a-asset-item id="table" src="assets/object/classic_round_side_table.glb"></a-asset-item>
        <a-asset-item id="mobile1" src="assets/object/mobile1.glb"></a-asset-item>
        <a-asset-item id="mobile2" src="assets/object/mobile2.glb"></a-asset-item>
        <a-asset-item id="mobile3" src="assets/object/mobile3.glb"></a-asset-item>

        <video id="video1" src="assets/films/Temoin1extra.mp4" playsinline crossorigin="anonymous" muted></video>
        <video id="video2" src="assets/films/Temoin2extra.mp4" playsinline crossorigin="anonymous" muted></video>
        <video id="video3" src="assets/films/Temoin3extra.mp4" playsinline crossorigin="anonymous" muted></video>

      </a-assets>

      <!-- CAMERA + CURSOR -->
      <a-entity camera look-controls position="0 1.6 4.9">
        <a-entity id="cursor"
                  cursor="fuse: true; fuseTimeout: 800"
                  raycaster="objects: .playable"
                  position="0 0 -1"
                  geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
                  material="shader: flat; color: #ff1111">
        </a-entity>
      </a-entity>

      <!-- OBJETS 3D -->
      <a-entity id="global" position="0 0 3.1">
        <a-entity gltf-model="#table" scale="3 0.22 3" position="0 0.87 0"></a-entity>

        <a-entity scale="0.5 0.5 0.5">
          <a-entity gltf-model="#mobile1" scale="0.1 0.08 0.1" position="-0.05 1.83 0.28" rotation="0 -56 0"></a-entity>
          <a-entity gltf-model="#mobile2" scale="0.01 0.01 0.01" position="0.09 1.87 -0.05"></a-entity>
          <a-entity gltf-model="#mobile3" position="0.48 1.82 0.40" scale="0.5 0.5 0.4" rotation="90 -120 0"></a-entity>
        </a-entity>
      </a-entity>

      <!-- VIDEOS / PANNEAUX -->
      <a-video class="playable"
               src="#video1"
               play-on-look="videoId: #video1"
               pop-out-on-look
               width="16" height="9"
               position="0.05 1.26 3.11"
               scale="0.013 0.053 0.1">
      </a-video>

      <a-video class="playable"
               src="#video2"
               play-on-look="videoId: #video2"
               pop-out-on-look
               width="16" height="9"
               position="0.16 1.26 3.28"
               scale="0.018 0.053 0.1"
               rotation="0 60 0">
      </a-video>

      <a-video class="playable"
               src="#video3"
               play-on-look="videoId: #video3"
               pop-out-on-look
               width="16" height="9"
               position="-0.04 1.26 3.29"
               scale="0.017 0.053 0.1"
               rotation="0 -56 0">
      </a-video>

    </a-scene>

    <!-- Activation audio -->
    <script>
      document.querySelector('#startAudio').addEventListener('click', () => {
        ['#video1', '#video2', '#video3'].forEach(id => {
          const v = document.querySelector(id);
          v.muted = false;
          v.play().catch(()=>{});
        });
        document.querySelector('#startAudio').style.display = 'none';
      });
    </script>

  </body>
</html>
